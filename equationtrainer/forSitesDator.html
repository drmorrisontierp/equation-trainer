<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ekvationlösningstränare</title>
    
    <style type="text/css">
        * {
    font-family: Verdana, Geneva, Tahoma, sans-serif;
    font-weight: bold;
font-size: 10pt;

}

#screen {
    display: grid;
    grid-template-columns:  59vw 39vw;
    grid-template-rows: 95vh;
    background-color: rgb(239, 244, 248);
}

#left {
    grid-area: 1/1/2/2;
    padding-left: 3vw;
    overflow-y: scroll;
    overflow-x: hidden;
    max-height: 95vh;
    border: solid black 1px;
    background-color: rgb(252, 252, 227);
}

#right {
    grid-area: 1/2/2/3;
    max-height: 95vh;
    background-color: rgb(239, 244, 248);
}

.row-group {
    display: grid;
    grid-template-columns: 200px 200px;
    grid-template-rows: 60px;
    column-gap: 20px;
}


.row {
    grid-area: 1/1/2/2;
    display: grid;
    grid-template-columns: repeat(7, 30px);
    grid-template-rows: 60px;
    column-gap: 5px;
}

.row-info {
    grid-area: 1/2/2/3;
    min-width: 200px;
    max-height: 40px;
    margin-left: 30px;
}

.bal-group {
    display: grid;
    grid-template-columns: 200px 200px;
    grid-template-rows: 60px;
    column-gap: 20px;
    margin-top: 10px;
    margin-left: -12px;
}

.bal {
    grid-area: 1/1/2/2;
    display: grid;
    grid-template-columns: repeat(7, 30px);
    grid-template-rows: 30px;
    padding-top: 5px;
    padding-bottom: 5px;
    column-gap: 5px;
}

.bal-info {
    grid-area: 1/2/2/3;
    min-width: 200px;
    max-height: 30px;
    margin-left: 40px;
    margin-top: -10px;
}

.plhs {
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.prhs {
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.num {
    border-bottom: solid black 1px;
    text-align: center;
}

.int {
    text-align: center;
}

.blhs {
    display: flex;
    flex-direction: column;
    border: solid black 1px;
    justify-content: center;
    text-align: center;
    width: 50px;
    background-color: white;
}

.brhs {
    display: flex;
    flex-direction: column;
    border: solid black 1px;
    justify-content: center;
    text-align: center;
    width: 50px;
    background-color: white;
}

.a-num {
    display: flex;
    flex-direction: column;
    border: solid black 1px;
    justify-content: center;
    text-align: center;
    min-width: 30px;
    min-height: 30px;
}
.a-int {
    display: flex;
    flex-direction: column;
    border: solid black 1px;
    justify-content: center;
    text-align: center;
    min-width: 30px;
    min-height: 30px;
}

#keyboard {
    display: grid;
    grid-template-columns: 120px 120px 120px;
    grid-template-rows: 180px 50px;
    gap: 30px;
    margin: 10px 0 0 8px;
}

#keypad {
    grid-area: 1/1/2/2;
    display: grid;
    grid-template-columns: 40px 40px 40px;
    grid-template-rows: 40px 40px 40px 40px;
    gap: 5px;
}

#operations {
    grid-area: 1/2/2/3;
    display: grid;
    grid-template-columns: 60px 60px;
    grid-template-rows: 40px 40px 40px 40px;
    gap: 5px;
}

#check {
    grid-area: 2/1/3/3;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: center;
    border: solid black 1px;
    background-color: rgb(177, 245, 175);
    min-width: 200px;
    height: 30px;
    margin-left: 25px;
    cursor: pointer;
    
}

#check:hover {
    background-color: rgb(67, 194, 78);
}


.button {
    border: solid black 1px;
    width: 40px;
    height: 40px;
    display: flex;
    background-color: aliceblue;
    flex-direction: column;
    justify-content: center;
    text-align: center;
    cursor: pointer;
}
.button:hover {
    background-color: aqua;
}

#dummy {
    width: 40px;
    height: 40px;
}

#plus {
    margin-left: 18px;
}
#times {
    margin-left: 18px;
}
#del {
    margin-left: 18px;
}
.arrow-button {
    border: solid black 1px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background-color: antiquewhite;
    text-align: center;
    cursor: pointer;
}

.arrow-button:hover {
    background-color: rgb(225, 181, 68);
}

#display {
    display: grid;
    grid-template-columns: 240px 195px;
    border: solid black 1px;
    border-radius: 5px;
    margin: 5px 5px 0 5px;
    background-color: rgb(255, 255, 255);
}

#info-title {
    text-decoration-line: underline;
    text-align: center;
}

#info-screen {
    margin: 2px 5px 2px 5px;
    min-width: 200px;
    min-height: 100px;
    text-align: left;
    font-weight: normal;
}
#reset-etc {
    display: grid;
    grid-template-rows: 40px 40px 40px 40px;
    grid-template-columns: 100px;
    row-gap: 5px;
    margin-left: -8px;
}
#level-row {
    display: grid;
    grid-template-columns: 40px 40px 40px;
    grid-template-rows: 40px;
    column-gap: 5px;
}
.reset-button {
    border: solid black 1px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background-color: antiquewhite;
    text-align: center;
    margin-left: 30px;
    min-height: 30px;
    max-width: 100px;
    cursor: pointer;
}


.reset-button:hover {
    background-color: rgb(225, 181, 68); 
}

#del {
    background-color: rgb(250, 224, 215);
}

#del:hover {
    background-color: lightcoral;
}

#clear {
    background-color: rgb(250, 224, 215);
}

#clear:hover {
    background-color: lightcoral;
}

#reset {
    background-color: rgb(250, 224, 215);
}

#reset:hover {
    background-color: lightcoral;
}

#level-minus, #level-plus {
    background-color: antiquewhite;
}

#level-minus:hover, #level-plus:hover {
    background-color: rgb(225, 181, 68);
}

#level-display {
    background-color: rgb(255, 255, 255);
    
}

#restart {
    margin-top: 10%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: center;
    
    border: solid black 1px;
    background-color: rgb(240, 255, 250);
}

#restart:hover {
    background-color: aquamarine;
}

#history {
    display: flex;
    flex-direction: column;
    align-content: left;
    justify-content: flex-start;
    
    
}

#history-outside {
    display: flex;
    flex-direction: column;
    align-content: left;
    justify-content: top;
    overflow-y: scroll;
    overflow-x: hidden;
    max-height: 200px;
    min-height: 200px;
    border: solid black 1px;
    border-radius: 2px;
}

#history-shell {
    display: flex;
    flex-direction: column;
    align-items: left;
    justify-content: top;
    
}

#history-title {
    display: flex;
    flex-direction: row;
    padding: 2px;
}

#title-button {
    margin-left: 10%;
    cursor: pointer;
    font-size: small;
    border: solid black 1px;
    background-color: rgb(250, 224, 215);
}

#title-button:hover {
    background-color: lightcoral;
}

.history-container {
    display: flex;
    flex-direction: row;
    justify-items: flex-start;
    
    max-height: 60px;
}

.button-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.history-button {
    cursor: pointer;
    display: flex;
    flex-direction: column;
    max-height: 13px;
    max-width: 12px;
    min-height: 13px;
    min-width: 12px;
    background-color:  rgb(250, 224, 215);
    border: solid black 1px;
    justify-content: center;
    margin-bottom: 7px;
}

.history-button:hover {
    background-color: lightcoral;
}

.history-row {
    cursor: pointer;
    display: grid;
    grid-template-columns: repeat(7, 20px);
    grid-template-rows: 20px;
    column-gap: 2px;
    max-height: 20px;
    font-size: 10px;
    padding-bottom: 10px;
    margin-left: 5px;
}

.history-row:hover {
    border: dotted black 1px;
}

#info-button {
    display: flex;
    flex-direction: column;
    align-items: center;
}

#info-button:hover {
    fill: rgb(224, 231, 236);
}

#info-popup {
    display: none;
    flex-direction: column;
    background-color: white;
    z-index: 10;
    grid-area: 1/1/2/3;
    margin: 5% 15% 5% 15%;
    border: solid black 1px;
    border-radius: 5px;
}

#information {
    margin: 2% 2% 2% 2%;
    overflow-y: scroll;
}

#window-bar {
    display: flex;
    flex-direction: column;
    background-color: rgb(249, 252, 255);
    justify-content: center;
    min-height: 22px;
    border-radius: 5px;
}

#bar-middle {
    display: flex;
    flex-direction: row;
    justify-content: flex-end;
}

#close-button {
    margin: 10px 5px 5px 5px;
}

#info-close:hover {
    fill: rgb(224, 231, 236);
}

#check-score-info {
    display: flex;
    flex-direction: row;
    row-gap: 10px;
}

#score {
    margin: 0 20px 0 20px;
    min-width: 60px;
    min-height: 20px;
    border: solid black 1px;
    align-items: center;
    text-align: center;
    background-color: white;
}
#score-text {
    font-size: 25px;
}
    </style>
</head>
<body>
    <div id="screen">
        <div id="info-popup">
            <div id="window-bar">
                <div id="bar-middle">
                    <div id="close-button" onclick="infoPopup()">
                        <svg width="16px" height="16px" xmlns="http://www.w3.org/2000/svg">
                            <g>
                                <circle id="info-close" cx="8" cy="8" r="7" stroke="black" stroke-width="1" fill="rgb(249, 252, 255)" />
                                <line x1="4" y1="4" x2="12" y2="12" stroke="black" stroke-width="1"/>
                                <line x1="12" y1="4" x2="4" y2="12" stroke="black" stroke-width="1"/>
                            </g>
                        </svg>
                    </div>
                </div>
            </div>
            <div id="information">
                <h2>Introduction</h2>
                <p>
                    This program is designed to teach and improve your ability to solve equations using the balance method.
                    You are given an equation to solve (as indicated by the speech bubble to the right).
                    
                </p>
                <p>
                    To solve the equation, you have to enter the appropriate operation or operations under the corresponding term. 
                    For instance, if the equation is
                </p>
                <p>
                    2x - 5 = 15
                </p>
                <p>
                    you will need to enter "+5" under both the term "5" and the term "15": i.e.
                </p>
                <p>
                    2x - 5 = 15 <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+5&nbsp;&nbsp;&nbsp;+5
                </p>
                <p>
                    After the "check" button is pressed the equation will change to, 
                </p>
                <p>
                    2x = 20
                </p>
                <p>
                    To complete the solution you will then have to enter "/2" under both the "2x" and "20" terms: i.e.
                </p>
                <p>
                    2x = 20 <br> /2&nbsp;&nbsp;&nbsp;/2

                </p>
                <p>
                    ...and thus you will get...
                </p>
                <p>
                    x = 10
                </p>
                <br>
                <h2>
                    Allowed operations
                </h2>
                <p>
                    The following operations are allowed to be entered under terms:
                </p>
                <p>
                    Additions: "+a", "+a/b", "+ax", "+ax/b", "+a/bx" (where "a" and "b" are integers).
                </p>
                <p>
                    Subtractions: "-a", "-a/b", "-ax", "-ax/b", "-a/bx" (where "a" and "b" are integers).
                </p>
                <p>
                    Multiplications: "*a", "*-a", "*a/b", "*-a/b", "*ax", "*-ax", "*ax/b", "*-a/bx", (where "a" and "b" are integers).
                </p>
                <p>
                    Divisions: "/a", "/-a", "/a/b", "/-a/b", "/ax", "/-ax", "/ax/b", "/-a/bx", (where "a" and "b" are integers).
                </p>
                <p>
                    Remember, in all cases except extensions and reductions, operations on both the left-hand-side and right-hand-side have to be equivalent and, as I have not 
                    included brackets, multiplication and division must be carried out on all the terms of the equation: i.e.
                </p>
                <p>
                    2x - 5 = 15 <br> /2&nbsp;&nbsp;&nbsp;/2&nbsp;&nbsp;&nbsp;/2
                </p>
                <p>
                    You can extend fractions by using "*a/a" and reduce them by using "/a/a" (however, reduction is generally
                    done automatically by the program.). An example of extension,
                </p>
                <p>
                    2x/3 - 5 = 15 + x/4 <br> *4/4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*3/3
                </p>
                <p>
                    ...will result in,
                </p>
                <p>
                    8x/12 - 5 = 15 + 3x/12
                </p>
                <p>
                    The program will prohibit the entering of incorrect operations.
                </p>
                <br>
                <h2>
                    Tips
                </h2>
                <p>
                    Carry out additions and subtractions first and only multiply or divide when there are 
                    single terms on the right- and left-hand-sides.
                </p>
            </div>
        </div>
        <div id="left">
            <div id="row-group-1" class="row-group">
                <div id="row-1" class="row">
                    <div id="p11" class="plhs">
                        <div class="int">4</div>
                    </div>
                    <div id="o12o" class="plhs">
                        <div class="int">-</div>
                    </div>
                    <div id="p12" class="plhs">
                        <div class="num">2x</div>
                        <div class="int">3</div>
                    </div>
                    <div class="plhs">
                        <div class="int">=</div>
                    </div>
                    <div id="p13" class="prhs">
                        <div class="num">6x</div>
                        <div class="int">3</div>
                    </div>
                    <div id="o14o" class="prhs">
                        <div class="int">+</div>
                    </div>
                    <div id="p14" class="prhs">
                        <div class="int">2</div>
                    </div>
                </div>
                <div id="row-info-1" class="row-info" >
                </div>
            </div>
            <div id="bal-group-1" class="bal-group">
                <div id="bal-1" class="bal">
                    <div id="b11" class="blhs" onmousedown="select(id)">*4/4</div>
                    <div id="b12b" class="blank"></div>
                    <div id="b12" class="blhs" onmousedown="select(id)">*2</div>
                    <div id="b13b" class="blank"></div>
                    <div id="b13" class="brhs" onmousedown="select(id)">*2</div>
                    <div id="b14b" class="blank"></div>
                    <div id="b14" class="brhs" onmousedown="select(id)"></div>
                </div>
                <div id="bal-info-1" class="bal-info" >
                </div>
            </div>
        </div>
    
        <div id="right">
            <div id="display">
                <div id="info">
                    <div id="info-title">
                        <div>Information</div>
                    </div>
                    <div id="info-screen"></div>
                </div>
                <div id="history">
                    <div id="history-title">
                        <div>History</div>
                        <div id="title-button" onclick="clearHistory()">clear history</div>
                    </div>
                    <div id="history-outside">
                    <div id="history-shell"></div>
                </div>
                </div>
            </div>
            <div id="keyboard">
                <div id="keypad">
                    <div id="7" class="button" onclick="enter('7')">7</div>
                    <div id="8" class="button" onclick="enter('8')">8</div>
                    <div id="9" class="button" onclick="enter('9')">9</div>
                    <div id="4" class="button" onclick="enter('4')">4</div>
                    <div id="5" class="button" onclick="enter('5')">5</div>
                    <div id="6" class="button" onclick="enter('6')">6</div>
                    <div id="1" class="button" onclick="enter('1')">1</div>
                    <div id="2" class="button" onclick="enter('2')">2</div>
                    <div id="3" class="button" onclick="enter('3')">3</div>
                    <div id="x" class="button" onclick="enter('x')">x</div>
                    <div id="0" class="button" onclick="enter('0')">0</div>
                    <div id="dummy"></div>
                </div>
                <div id="operations">
                    <div id="plus" class="button" onclick="enter('+')">+</div>
                    <div id="minus" class="button" onclick="enter('-')">-</div>
                    <div id="times" class="button" onclick="enter('*')">*</div>
                    <div id="divided" class="button" onclick="enter('/')">/</div>
                    <div id="left-arrow" class="arrow-button" onclick="moveThrough('left')">&#8678</div>
                    <div id="right-arrow" class="arrow-button" onclick="moveThrough('right')">&#8680</div>
                    <div id="del" class="button" onclick="del()">del</div>
                    <div id="clear" class="button" onclick="back()">back</div>
                </div>
                <div id="reset-etc">
                    <div id="level-row">
                        <div id="level-minus" class="button" onclick="changeLevel('down')">-</div>
                        <div  id="level-display" class="button">1</div>
                        <div id="level-plus" class="button" onclick="changeLevel('up')">+</div>
                    </div>
                    <div id="new" class="reset-button" onclick="newLevel()">level</div>
                    <div id="custom" class="reset-button" onclick="addEquation(2, emptyArray)">custom</div>
                    <div id="reset" class="reset-button" onclick="addEquation(3, newArray)">reset</div>
                </div>
                <div id="check-score-info" >
                <div id="check" class="check-button" onclick="check()">check</div>
                <div id="score" >SCORE <br><span id="score-text">0</span></div>
                <div id="info-button" onclick="infoPopup()">
                    <svg width="40px" height="40px" xmlns="http://www.w3.org/2000/svg">
                        <g>
                            <circle id="info-button" cx="20" cy="20" r="16" stroke="black" stroke-width="2" fill="rgb(239, 244, 248)"/>
                            <circle cx="20" cy="12" r="2" stroke="black" fill="black"/>
                            <line x1="20" y1="17" x2="20" y2="30" stroke="black" stroke-width="4"/>
                        </g>
                    </svg>
                </div>
            </div> 
            </div>
        </div>
    </div>

    <script type="text/javascript" >
    // Global variables
let row = 1;
let available = ["b11", "b12", "b13", "b14"]
let index = 0
let selected = available[index];
let stopped = false
let creating = false
let emptyArray = ["", "", "", "", "", "", "", "", "", ""]
let testArray = ["2x", "3", "-", "5", "1", "4", "5", "+", "2x", "1"]
let newArray = ["2x", "3", "-", "5", "1", "4", "5", "+", "2x", "1"]
let history = {}
let historyId = 0
let level = 1
let popupOpen = false
let bonus = 1
let score = 0
const infoShape = `"M5 30 L20 15 L20 22 L30 22 L30 15 Q30 5 40 5 L320 5 Q330 5 330 15 L330 45 Q 330 55 320 55 L40 55 Q 30 55 30 45 L30 37 L20 37 L20 45 L5 30"`

newArray = createEquation(level-1)

addEquation(1, newArray)

const warningsText = (warning, args) => {
    let warningsText = ""
    if (warning === "x-fault") {
        warningsText = `When manipulating an expression by addition or subtraction,
            it is important that the terms have a similar value.<br><br>Terms that contain "x"
            have an unknown value and thus one cannot add or subtract them with a known
            value and vice-versa.<br><br>`
        if (args.length === 1) {
            warningsText += `Please look at position ${args[0]}.`
        } else if (args.length === 2) {
            warningsText += `Please look at positions ${args[0]} and ${args[1]}.`
        } else if (args.length === 3) {
            warningsText += `Please look at positions ${args[0]}, ${args[1]} and ${args[2]}.`
        } else if (args.length === 4) {
            warningsText += `Please look at all the positions.`
        }
    } else if (warning === "addition-fault") {
        if (args.length === 1) {
            warningsText = ""
        } else if (args.length === 2) {
            warningsText = ""
        } else if (args.length === 3) {
            warningsText = ""
        } else if (args.length === 3) {
            warningsText = ""
        }
    } else if (warning === "extend-fault") {
        let operation = args[0]
        if (args.length === 1) {
            warningsText = ""
        } else if (args.length === 2) {
            warningsText = ""
        } else if (args.length === 3) {
            warningsText = ""
        } else if (args.length === 3) {
            warningsText = ""
        }
        warningsText = `When you ${operation ? 'extend' : 'reduce'} a fraction,
        you should be ${operation ? 'multiplying' : 'dividing'} by a fraction that
        is equivalent to one: i.e. ${args[1]}/${args[1]} or ${args[2]}/${args[2]}`

    } else if (warning === "balance-fault") {
        console.log("running")
        warningsText = `When balancing an equation, one needs to have exactly the same operations
         manipulating expressions on both sides of the equation.<br><br> I see you have the equivalent of 
         ${args[0]} on the left hand side and ${args[1]} on the right: they are not the same.`
    } else if (warning === "multiplication-fault") {
        if (args.length === 1) {
            warningsText = ""
        } else if (args.length === 2) {
            warningsText = ""
        } else if (args.length === 3) {
            warningsText = ""
        } else if (args.length === 3) {
            warningsText = ""
        }
    }
    return warningsText

}

const levelInfo = {
    1: `Nivå 1: Ekvationer i form av <br> <span style="font-weight:bold">&nbsp&nbsp&nbsp&nbsp x + c = h </span> <br> med en heltalslösning. <br> Bonus: 1`,
    2: `Nivå 2: Ekvationer i form av <br> <span style="font-weight:bold">&nbsp&nbsp&nbsp&nbsp ax = h </span> <br> med en heltalslösning. <br> Bonus: 1`,
    3: `Nivå 3: Ekvationer i form av <br> <span style="font-weight:bold">&nbsp&nbsp&nbsp&nbsp x/b = h </span> <br> med en heltalslösning. <br> Bonus: 1`,
    4: `Nivå 4: Ekvationer i form av <br> <span style="font-weight:bold">&nbsp&nbsp&nbsp&nbsp ax + c = h </span> <br> med en heltalslösning. <br> Bonus: 3`,
    5: `Nivå 5: Ekvationer i form av <br> <span style="font-weight:bold">&nbsp&nbsp&nbsp&nbsp ax/b + c = h </span> <br> med en heltalslösning. <br> Bonus: 4`,
    6: `Nivå 6: Ekvationer i form av <br> <span style="font-weight:bold">&nbsp&nbsp&nbsp&nbsp ax/b + c/d = h/k </span> <br> med en heltalslösning. <br> Bonus: 6`,
    7: `Nivå 7: Ekvationer i form av <br> <span style="font-weight:bold">&nbsp&nbsp&nbsp&nbsp ax + c = h + mx </span> <br> med en heltalslösning. <br> Bonus: 6`,
    8: `Nivå 8: Ekvationer i form av <br> <span style="font-weight:bold">&nbsp&nbsp&nbsp&nbsp ax/b + c/d = h/k + mx/n </span> <br> med en rationeltalslösning. <br> Bonus: 8`,
    9: "Nivå 9: Ekvationer där alla positioner är randomiserat. <br> Bonus: 10",
}

element("info-screen").innerHTML = levelInfo[level]

// Select the first available position in the first balance row
select(available[0])

function newLevel() {
    if (("123").includes(level.toString())) bonus = 1
    if (("4").includes(level.toString())) bonus = 3
    if (("5").includes(level.toString())) bonus = 4
    if (("67").includes(level.toString())) bonus = 6
    if (("8").includes(level.toString())) bonus = 8
    if (("9").includes(level.toString())) bonus = 10
    newArray = createEquation(level-1)
    addEquation(1, newArray)
}

// Add event listeners
document.addEventListener("keydown", handleKeydown);

function restart() {
    console.log(level)
    stopped = false
    creating = false
    newArray = createEquation(level-1)
    addEquation(1, newArray)
    element("row-info-1").innerHTML = `
        <svg width="280px" height="60px" xmlns="http://www.w3.org/2000/svg">
           <path d=${infoShape} stroke="black" fill="white"/>
            <text X="37" Y="25" >the equation that should be solved</text>
            <text X="37" Y="45" >for "x" using the balance method</text>
        </svg>
`
}

function changeLevel(direction) {
    if (direction === "up") {
        if (level < 9) {
            level++
            element("info-screen").innerHTML = levelInfo[level]
        } else {
            level = 9
        }
    } else {
        if (level > 1) {
            level--
            element("info-screen").innerHTML = levelInfo[level]
        } else {
            level = 1
        }
    }
    element("level-display").innerHTML = level
}


function createEquation(level) {
    let newArray = ["", "", "", "", "", "", "", "", "", ""]

    let s = Math.round(Math.random() * 20 + 1) * ("123456".includes(level.toString()) ? 1 : (Math.round(Math.random() * 100) < 50 ? 1 : -1))
    let c0 = Math.round(Math.random() * 99 + 1) * (Math.round(Math.random() * 100) < 50 ? 1 : -1)
    let c4 = Math.round(Math.random() * 25 + 1) * (Math.round(Math.random() * 100) < 50 ? 1 : -1)
    let a = Math.round(Math.random() * 7 + 2)
    let b = Math.round(Math.random() * 8 + 1)
    let c = Math.round(Math.random() * 20 + 1) * (Math.round(Math.random() * 100) < 50 ? 1 : -1)
    let d = Math.round(Math.random() * 8 + 1)
    let m = Math.round(Math.random() * 20 + 1)
    let n = Math.round(Math.random() * 8 + 1)
    let o = Math.round(Math.random() * 12 + 1) * (Math.round(Math.random() * 100) < 50 ? 1 : -1)
    let p = Math.round(Math.random() * 8 + 1)

    if ("78".includes(level.toString())) {
        while (a / b == (o / p)*(-1)) {
            console.log("new o")
            o = Math.round(Math.random() * 12 + 1) * (Math.round(Math.random() * 100) < 50 ? 1 : -1)
        }
        while (c / d == (o / p)*(-1)) {
            console.log("new c")
            c = Math.round(Math.random() *20 + 1) * (Math.round(Math.random() * 100) < 50 ? 1 : -1)
        }
        while (c / d == (m / n)*(-1)) {
            console.log("new m")
            m = Math.round(Math.random() * 20 + 1)
        }
    }
    if ("4".includes(level.toString())) {
        while (s * a % b !== 0) {
            console.log("new b")
            b = Math.round(Math.random() * 8 + 1)
        }
    }
    let j = Math.round(Math.random() * (a-1) + 1) * (Math.round(Math.random() * 100) < 50 ? 1 : -1)
    let k = a - j
    let a6 = k
    let o6 = j * (-1)
    let [x, y, x1, y1, b1, a1, o1] = [0, 0, 0, 0, 0, 0]

    if ("5".includes(level.toString())) {
        x = Math.round(Math.random() * 8 + 1) * (Math.round(Math.random() * 100) < 50 ? 1 : -1)
        y = Math.round(Math.random() * 8 + 1)
        x1 = Math.round(Math.random() * 8 + 1)
        y1 = Math.round(Math.random() * 8 + 1)
        b1 = Math.round(Math.random() * 3 + 1)
        a1 = Math.round(Math.random() * 8 + 1)
        o1 = Math.round(Math.random() * 8 + 1) * (Math.round(Math.random() * 100) < 50 ? 1 : -1)

        while ((x + x1) % a !== 0) {
            console.log("new x")
            x = Math.round(Math.random() * 8 + 1)
        }
        while ((y + y1) % a !== 0) {
            console.log("new y")
            y = Math.round(Math.random() * 8 + 1)
        }
    }

    if (level === 0) {
        newArray[0] = "x"
        newArray[1] = "1"
        newArray[2] = (c0.toString())[0] === "-" ? "-" : "+"
        newArray[3] = (c0.toString())[0] === "-" ? c0.toString().slice(1) : c0.toString();
        newArray[4] = "1"
        newArray[5] = (s - c0).toString()
        newArray[6] = "1"
        newArray[7] = ""
        newArray[8] = ""
        newArray[9] = ""
    }
    if (level === 1) {
        newArray[0] = a.toString() + "x"
        newArray[1] = "1"
        newArray[2] = ""
        newArray[3] = ""
        newArray[4] = "1"
        newArray[5] = (a * s).toString()
        newArray[6] = "1"
        newArray[7] = ""
        newArray[8] = ""
        newArray[9] = ""
    }
    if (level === 2) {
        newArray[0] = "x"
        newArray[1] = a.toString()
        newArray[2] = ""
        newArray[3] = ""
        newArray[4] = "1"
        newArray[5] = Math.round(Math.random() * 20 + 1).toString()
        newArray[6] = "1"
        newArray[7] = ""
        newArray[8] = ""
        newArray[9] = ""
    }
    if (level === 3) {
        newArray[0] = a.toString() + "x"
        newArray[1] = "1"
        newArray[2] = c0.toString()[0] === "-" ? "-" : "+"
        newArray[3] = c0.toString()[0] === "-" ? c0.toString().slice(1) : c0.toString();
        newArray[4] = "1"
        newArray[5] = (s * a + c0).toString()
        newArray[6] = "1"
        newArray[7] = ""
        newArray[8] = ""
        newArray[9] = ""
    }
    if (level === 4) {
        console.log((s * a) % b == 0)
        newArray[0] = (a / gcd(a, b)).toString() + "x"
        newArray[1] = (b / gcd(a, b)).toString()
        newArray[2] = c4.toString()[0] === "-" ? "-" : "+"
        newArray[3] = c4.toString()[0] === "-" ? c4.toString().slice(1) : c4.toString();
        newArray[4] = "1"
        newArray[5] = (s * a) % b == 0 ? ((s * a + c4 * b) / b).toString() : ((s * a + c4)).toString()
        newArray[6] = "1"
        newArray[7] = ""
        newArray[8] = ""
        newArray[9] = ""
    }
    if (level === 5) {
        newArray[0] = (a / gcd(a, (x1 * y1 * b1))).toString() + "x"
        newArray[1] = ((x1 * y1 * b1) / gcd(a, (x1 * y1 * b1))).toString()
        newArray[2] = (x.toString()[0] === "-" ? "-" : "+")
        newArray[3] = (x.toString()[0] === "-" ? (x / gcd(x, (x1 * b1))).toString().slice(1) : (x / gcd(x, (x1 * b1))).toString())
        newArray[4] = ((x1 * b1) / gcd(x, (x1 * b1))).toString()
        newArray[5] = (y / gcd(y, (y1 * b1))).toString()
        newArray[6] = ((y1 * b1) / gcd(y, (y1 * b1))).toString()
        newArray[7] = ""
        newArray[8] = ""
        newArray[9] = ""
    }
    if (level === 6) {
        newArray[0] = (a6).toString() + "x"
        newArray[1] = "1"
        newArray[2] = (c4.toString()[0] === "-" ? "-" : "+")
        newArray[3] = (c4.toString()[0] === "-" ? c4.toString().slice(1) : c4.toString())
        newArray[4] = "1"
        newArray[5] = (s * a + c4).toString()
        newArray[6] = "1"
        newArray[7] = (o6.toString()[0] === "-" ? "-" : "+")
        newArray[8] = (o6.toString()[0] === "-" ? o6.toString().slice(1) + "x" : o6.toString() + "x")
        newArray[9] = "1"
    }
    
    if (level === 7) {
        newArray[0] = (a / gcd(a, b)).toString() + "x"
        newArray[1] = (b / gcd(a, b)).toString()
        newArray[2] = (c.toString()[0] === "-" ? "-" : "+")
        newArray[3] = (c.toString()[0] === "-" ? (c / gcd(c, d)).toString().slice(1) : (c / gcd(c, d)).toString())
        newArray[4] = (d / gcd(c, d)).toString()
        newArray[5] = (m / gcd(m, n)).toString()
        newArray[6] = (n / gcd(m, n)).toString()
        newArray[7] = (o.toString()[0] === "-" ? "-" : "+")
        newArray[8] = (o.toString()[0] === "-" ? (o / gcd(o, p)).toString().slice(1) + "x" : (o / gcd(o, p)).toString() + "x")
        newArray[9] = (p / gcd(o, p)).toString()
    }
    if (level === 8) {
        let xpos1 = (Math.round(Math.random() * 100) < 50 ? true : false)
        let xpos3 = (Math.round(Math.random() * 100) < 50 ? true : false)
        let xnum = (Math.round(Math.random() * 100) < 50 ? true : false)
        newArray[0] = (a / gcd(a, b)).toString() + (!xpos1 ? "" : xnum ? "x" : "")
        newArray[1] = (b / gcd(a, b)).toString() + (!xpos1 ? "" : xnum ? "" : "x")
        newArray[2] = (c.toString()[0] === "-" ? "-" : "+")
        newArray[3] = (c.toString()[0] === "-" ? (c / gcd(c, d)).toString().slice(1) + (xpos1 ? "" : xnum ? "x" : "") : (c / gcd(c, d)).toString() + (xpos1 ? "" : xnum ? "x" : ""))
        newArray[4] = (d / gcd(c, d)).toString() + (xpos1 ? "" : xnum ? "" : "x")
        newArray[5] = (m / gcd(m, n)).toString() + (!xpos3 ? "" : xnum ? "x" : "")
        newArray[6] = (n / gcd(m, n)).toString() + (!xpos3 ? "" : xnum ? "" : "x")
        newArray[7] = (o.toString()[0] === "-" ? "-" : "+")
        newArray[8] = (o.toString()[0] === "-" ? (o / gcd(o, p)).toString().slice(1) + (xpos3 ? "" : xnum ? "x" : "") : (o / gcd(o, p)).toString() + (xpos3 ? "" : xnum ? "x" : ""))
        newArray[9] = (p / gcd(o, p)).toString() + (xpos3 ? "" : xnum ? "" : "x")
    }
    return newArray
}

/**
 * Helper function to replace document.getElementById(id).
 * @param {string} id - The ID of the element to retrieve.
 * @returns {HTMLElement} - A HTMLElement object.
 */
function element(id) {
    return document.getElementById(id);
}


/**
 * Helper function to replace document.getElementsByClassName(id).
 * @param {string} id - The class name of the elements to retrieve.
 * @returns {HTMLCollection} - A live HTMLCollection of elements with the specified class name.
 */
function className(id) {
    return document.getElementsByClassName(id);
}

const scrollToBottom = (id) => {
    const element = document.getElementById(id);
    element.scrollTop = element.scrollHeight;
}

const countChars = (str, char) => {
    let count = 0
    if (str === "") return 0;
    for (let x = 0; x < str.length; x++) {
        if (str[x] === char) count++;
    }
    return count
}


/**
 * Sets attributes for an element.
 * @param {HTMLElement} element - The element to set attributes on.
 * @param {Object} attributes - An object containing attribute key-value pairs.
 */
function setAttributes(element, attributes) {
    // Ensure that element is a DOM element
    if (typeof element === "string") {
        element = document.querySelector(element);
    }

    // Iterate over the attributes object and set each attribute
    for (let key in attributes) {
        if (attributes.hasOwnProperty(key)) {
            element.setAttribute(key, attributes[key]);
        }
    }
}


/**
 * Checks if two arrays contain the same items in the same quantities.
 *
 * @param {Array} arr1 - The first array to compare.
 * @param {Array} arr2 - The second array to compare.
 * @returns {boolean} - True if the arrays contain the same items in the same quantities, false otherwise.
 */
function arraysEqual(arr1, arr2) {
    if (arr1.length !== arr2.length) {
        return false;
    }
    const sortedArr1 = arr1.slice().sort();
    const sortedArr2 = arr2.slice().sort();
    for (let i = 0; i < sortedArr1.length; i++) {
        if (sortedArr1[i] !== sortedArr2[i]) {
            return false;
        }
    }
    return true;
}

/**
 * Calculates the greatest common divisor of two numbers.
 * @param {number} a - First number.
 * @param {number} b - Second number.
 * @returns {number} - The greatest common divisor.
 */
function gcd(a, b) {
    a = Math.abs(a);
    b = Math.abs(b);
    if (b > a) { let temp = a; a = b; b = temp; }
    while (b !== 0) {
        let c = a % b
        a = b
        b = c
    }
    return a
}


/**
 * Handles keydown events by performing different actions based on the pressed key.
 *
 * @param {KeyboardEvent} event - The keydown event object.
 */
function handleKeydown(event) {
    const key = event.key;
    if (stopped) return
    if (key === "Backspace") {
        del();
    } else if (key === "Enter") {
        check()
    } else if (key === "ArrowRight") {
        moveThrough("right")
    } else if (key === "ArrowLeft") {
        moveThrough("left")
    } else if (key === "/") {
        enter("/");
    } else if (key === "*") {
        enter("*");
    } else if (key === "-") {
        enter("-");
    } else if (key === "+") {
        enter("+");
    } else if (key === "x") {
        enter("x");
    } else if (key === "Escape") {
        addEquation(2, emptyArray);
    } else if (key === "Delete") {
        addEquation(1, newArray);
    } else if (!isNaN(key)) {
        enter(key);
    }
}


function addEquation(flag, arr) {
    stopped = false
    element("info-screen").innerHTML = ""
    let target = element("left");  // returns an element with id "left"

    // Convert HTMLCollection to an array
    let childrenArray = Array.from(target.children);

    // Iterate over the array and remove each child
    for (let child of childrenArray) {
        child.remove();
    }
    row = 1
    let newRowGroup = document.createElement("div")
    let newRow = document.createElement("div")
    let newRowInfo = document.createElement("div")
    setAttributes(newRowGroup, { "id": "row-group-1", "class": "row-group" })
    setAttributes(newRow, { "id": "row-1", "class": "row" })
    setAttributes(newRowInfo, { "id": "row-info-1", "class": "row-info" })

    newRowInfo.innerHTML = `<svg width="400px" height="60px" xmlns="http://www.w3.org/2000/svg">
    <path d=${infoShape} stroke="black" fill="white"/>
    <text X="37" Y="25" >the equation that should be solved</text>
    <text X="37" Y="45" >for "x" using the balance method</text>
</svg>`

    newRow.innerHTML = `    
        <div id="p11" class="plhs">
            <div id="p11a" class="a-num">${arr[0]}</div>
            <div id="p11b" class="a-int">${arr[1]}</div>
        </div>
        <div id="o12o" class="plhs">
            <div id="o12oa" class="a-int">${arr[2]}</div>
        </div>
        <div id="p12" class="plhs">
            <div id="p12a" class="a-num">${arr[3]}</div>
            <div id="p12b" class="a-int">${arr[4]}</div>
        </div>
        <div class="plhs">
            <div class="int">=</div>
            </div>
        <div id="p13" class="prhs">
            <div id="p13a" class="a-num">${arr[5]}</div>
            <div id="p13b" class="a-int">${arr[6]}</div>
        </div>
        <div id="o14o" class="prhs">
            <div id="o14oa" class="a-int">${arr[7]}</div>
        </div>
        <div id="p14" class="prhs">
            <div id="p14a" class="a-num">${arr[8]}</div>
            <div id="p14b" class="a-int">${arr[9]}</div>
        </div>
    `
    newRowGroup.appendChild(newRow)
    newRowGroup.appendChild(newRowInfo)
    target.appendChild(newRowGroup)
    creating = true
    available = ["p11a", "p11b", "o12oa", "p12a", "p12b", "p13a", "p13b", "o14oa", "p14a", "p14b"]
    selected = available[0]
    select(selected)


    if (1 || 3) check()
}

function setBonus(level) {
    if ("123".includes(level.toString())) {
        bonus = 1
    } else if ("4".includes(level.toString())) {
        bonus = 4
    } else if ("5".includes(level.toString())) {
        bonus = 6
    } else if ("6".includes(level.toString())) {
        bonus = 12
    } else if ("7".includes(level.toString())) {
        bonus = 14
    } else if ("8".includes(level.toString())) {
        bonus = 16
    } else if ("9".includes(level.toString())) {
        bonus = 16
    } else {
        bonus = 25
    }
}

function enter(key) {
    if (stopped) return
    let entered = element(selected).innerHTML
    const divChars = countChars(entered, "/")
    const xChars = countChars(entered, "x")
    lastEntered = ""
    if (entered !== "") {
        lastEntered = entered[entered.length - 1]
    } else {
        lastEntered = "m"
    }
    if (!creating) {
        if (key === "/" && ("+-/".includes(lastEntered) || divChars > 1)) return
        if (key === "*" && entered !== "") return
        if ("+-".includes(key) && !("/*".includes(lastEntered) || entered === "")) return
        if (key === "x" && !"0123456789-/+*".includes(lastEntered)) return
        if ("0123456789".includes(key) && !"0123456789-/+*".includes(lastEntered)) return
    } else {
        if ("/*".includes(key)) return
        if ("+-".includes(key) && selected[0] !== "o") return
        if ("123456789".includes(key) && (lastEntered === "x" || selected[0] === "o")) return
        if (key === "0" && (entered === "m" || entered === "") && element(selected).className === "a-int") return
        if (key === "x" && xChars > 1) return
        if (key === "x" && selected[0] === "o") return
    }
    element(selected).innerHTML += key;

}


/**
 * Remove the last character from the selected DOM elements innerHTML.
 * 
 * @param {string} selected - The ID of the selected element.
 */
function del() {
    if (stopped) return
    let expr = element(selected).innerHTML;
    element(selected).innerHTML = expr.slice(0, -1);
}

/**
 * Remove the last character from the selected DOM elements innerHTML.
 * 
 * @param {string} selected - The ID of the selected element.
 */
function back() {
    "running back"
    if (stopped) {
        return
    } else {
        element("info-screen").innerHTML = ""
        if (row === 1) return
        element(`bal-group-${row}`).remove()
        element(`row-group-${row}`).remove()
        row--
        element(`row-info-${row}`).style.display = "grid"
        element(`bal-group-${row}`).remove()
        createBalanceRow()
        available = []
        for (let x = 1; x < 5; x++) {
            if (element(`p${row}${x}`).children[0].innerHTML !== "" && element(`p${row}${x}`).children[0].innerHTML !== "0") {
                available.push(`b${row}${x}`)
            } else {
                element(`b${row}${x}`).style.display = "none"
                if (x === 1 || x === 2) {
                    element(`bal-${row}`).style.marginLeft = "80px"
                    element(`b${row}${2}b`).style.display = "none"
                } else {
                    element(`b${row}${4}b`).style.display = "none"
                }
            }
        }
        selected = available[0]
        select(selected)
    }
}


/**
 * Modifies the `available` array by prepending the `row` number to each ID.
 *
 * @param {Array<string>} available - An array of IDs to be modified.
 * @param {number} row - The row number to prepend to each ID.
 */
function setAvailable() {
    for (let x = 0; x < available.length; x++) {
        available[x] = `b${row}${available[x][available[x].length - 1]}`
    }
}


/**
 * Change the border color of the old selected element to black
 * and the new selected element to gold.
 *
 * @param {string} id - The ID of the newly selected element.
 * @param {string} selected - The ID of the currently selected element (global variable).
 */
function select(id) {
    if (stopped) return
    let rowText = row.toString()
    if (id.slice(1, 1 + rowText.length) === rowText) {
        element(selected).style.borderColor = "black";
        index = available.indexOf(id)
        selected = available[index];
        element(id).style.borderColor = "gold";
    }
}


/**
 * Change the border color of the old selected element to black,
 * choose a new selected element ID from the array of available IDs
 * and change the border color the new selected element to gold.
 *
 * @param {Array<string>} available - The array of available IDs.
 * @param {string} direction - A string to indicate if index should increase ore decrease 
 * @param {number} index - The index of the currently selected elements ID in the array of available IDs.
 * @param {string} selected - The ID of the currently selected element (global variable).
 */
function moveThrough(direction) {
    element(selected).style.borderColor = "black";
    if (direction === "right") {
        index = index < available.length - 1 ? index += 1 : 0;
        selected = available[index]
    } else {
        index = index > 0 ? index -= 1 : available.length - 1;
        selected = available[index]
    }
    element(selected).style.borderColor = "gold";
}


function checkWin() {
    let plhsNum = ""; // String to hold the current row's left-hand-sides values
    let plhsDen = ""; // String to hold the current row's left-hand-sides values
    let prhsNum = ""; // String to hold the current row's right-hand-sides values
    let prhsDen = ""; // String to hold the current row's right-hand-sides values
    // Process the current row's elements to populate the p array
    for (let x = 1; x < 3; x++) {
        if (element(`p${row}${x}`).children[0].innerHTML !== "0") plhsNum += element(`p${row}${x}`).children[0].innerHTML
        if (element(`p${row}${x}`).children.length > 1) {
            if (element(`p${row}${x}`).children[1].innerHTML !== "0") plhsDen += element(`p${row}${x}`).children[1].innerHTML
        }
        if (element(`p${row}${x + 2}`).children[0].innerHTML !== "0") prhsNum += element(`p${row}${x + 2}`).children[0].innerHTML
        if (element(`p${row}${x + 2}`).children.length > 1) {
            if (element(`p${row}${x + 2}`).children[1].innerHTML !== "0") prhsDen += element(`p${row}${x + 2}`).children[1].innerHTML
        }
    }

    if ((((plhsNum === "x" && prhsNum !== "x") || (plhsNum === "1x" && prhsNum !== "1x")) && (plhsDen === "" || plhsDen === "1"))
        || ((prhsNum === "x" && plhsNum !== "x") || (prhsNum === "1x" && plhsNum !== "1x")) && (prhsDen === "" || prhsDen === "1")) {
        //element("info-screen").innerHTML = ""
        element(`bal-${row}`).innerHTML = ""
        element(`row-${row}`).style.borderBottom = "double"
        element(`row-${row}`).style.marginRight = "70px"
        element(`row-${row}`).style.width = "50%"
        element(`row-info-${row}`).innerHTML = `<div id="restart" onclick="restart()">click here for a new equation</div>`
        element(`bal-info-${row}`).style.display = "none"
        score = score + bonus
        element("score-text").innerHTML = score

        stopped = true

    } else {
        return
    }

}

/**
 * Checks the added equation for mathematical rules
 */
function checkEquation() {
    let lhs = ""
    let rhs = ""
    let nums = []
    let dens = []
    for (let x of [0, 3, 5, 8]) {
        if (element(available[x]).innerHTML.includes("x") && element(available[x + 1]).innerHTML.includes("x")) {
            element(available[x]).innerHTML = element(available[x]).innerHTML.length > 1 ? element(available[x]).innerHTML.replace("x", "") : "1"
            element(available[x + 1]).innerHTML = element(available[x + 1]).innerHTML.length > 1 ? element(available[x + 1]).innerHTML.replace("x", "") : "1"
        }
        nums.push(element(available[x]).innerHTML)
        dens.push(element(available[x + 1]).innerHTML)
        if (element(available[x]).innerHTML === "" || element(available[x]).innerHTML === "0") {
            if (x === 0 || x === 3) {
                lhs += "0"
            } else {
                rhs += "0"
            }
        } else if (element(available[x]).innerHTML !== "") {
            if (element(available[x + 1]).innerHTML === "1" || element(available[x + 1]).innerHTML === "") {
                if (x === 0 || x === 3) {
                    lhs += element(available[x]).innerHTML
                } else {
                    rhs += element(available[x]).innerHTML
                }

            } else {
                if (x === 0 || x === 3) {
                    lhs += element(available[x]).innerHTML
                    lhs += element(available[x + 1]).innerHTML
                } else {
                    rhs += element(available[x]).innerHTML
                    rhs += element(available[x + 1]).innerHTML
                }

            }
        }
    }
    return { lhs, rhs, nums, dens }
}

function checkForZeros() {
    let zeros = []
    for (let x = 1; x < 5; x++) {
        if (element(`p1${x}`).children[0].innerHTML === "0" || element(`p1${x}`).children[0].innerHTML === "") {
            element(`p1${x}`).children[0].innerHTML === "0"
            element(`p1${x}`).children[1].innerHTML === "0"
            zeros.push(`${x}`)
        }
    }
    return zeros
}

function changeXToOneX(x) {
    if (element(`p1${x}`).children[1].innerHTML === "") element(`p1${x}`).children[1].innerHTML = "1"
    if (element(`p1${x}`).children[0].innerHTML === "x") element(`p1${x}`).children[0].innerHTML = "1x"
    if (element(`p1${x}`).children[0].innerHTML === "-x") element(`p1${x}`).children[0].innerHTML = "-1x"
    if (element(`p1${x}`).children[1].innerHTML === "x") element(`p1${x}`).children[1].innerHTML = "1x"
}

function completeCheckWithAddEquation() {
    creating = false
    let values = []
    target = element(`row-1`)
    let targetChildren = Array.from(target.children)
    
       values = [
        targetChildren[0].children[0].innerHTML,
        targetChildren[0].children.length > 1 ? targetChildren[0].children[1].innerHTML : "1",
        targetChildren[1].children[0].innerHTML,
        targetChildren[2].children[0].innerHTML,
        targetChildren[2].children.length > 1 ? targetChildren[2].children[1].innerHTML : "1",
        targetChildren[4].children[0].innerHTML,
        targetChildren[4].children.length > 1 ? targetChildren[4].children[1].innerHTML : "1",
        
        targetChildren[5].children[0].innerHTML,
        targetChildren[6].children[0].innerHTML,
        targetChildren[6].children.length > 1 ? targetChildren[6].children[1].innerHTML : "1",
        
       ]
    
    available = []
    for (let x = 0; x < 4; x++) {
        available[x] = `b1${x + 1}`
    }
    row = 1
    selected = available[0]
    createBalanceRow()
    hideUnused()
    selected = available[0]
    
    createHistory(values)
    select(selected)
}

/**
         * Completes the process after an operation is performed.
         * This includes creating a new balance row, updating the row counter,
         * setting available elements, and updating the UI.
         */
function completeCheck() {

    element(selected).style.borderColor = "black";
    row++;
    createBalanceRow();
    setAvailable();
    selected = available[0];
    select(selected);
    hideUnused();
    updateRow();
    scrollToBottom("left");
    checkWin()
}

/**
 * Checks the current row's equation, validates the inputs, and decides which operation to perform.
 */

function check() {
    if (stopped) return
    element("info-screen").innerHTML = ""
    if (creating) {
        const { lhs, rhs, nums, dens } = checkEquation()
        if (lhs.length === 0) return
        if (rhs.length === 0) return
        if (!lhs.includes("x") && !rhs.includes("x")) return
        if (nums.join().includes("x") && dens.join().includes("x")) return

        const zeros = checkForZeros()
        if (zeros.length > 2) return
        for (let x = 1; x < 5; x++) {
            changeXToOneX(x)
        }
        //newArray = []

        // Check conditions
        for (let x of [1, 3]) {
            // Get raw innerHTML values
            let p11a = element(`p1${x}`).children[0].innerHTML;
            let p12a = element(`p1${x + 1}`).children[0].innerHTML;
            let p11b = element(`p1${x}`).children[1].innerHTML;
            let p12b = element(`p1${x + 1}`).children[1].innerHTML;
            let o12o = element(`o1${x + 1}o`).children[0].innerHTML;

            if ((p11a.includes("x") && p12a.includes("x")) && (!p11b.includes("x") && !p12b.includes("x")) ||
                (!p11a.includes("x") && !p12a.includes("x") && (p11a !== "" || p11a !== "") && (p12a !== "" || p12a !== "")) && (p11b.includes("x") && p12b.includes("x")) ||
                (!p11a.includes("x") && !p12a.includes("x") && (p11a !== "" || p11a !== "") && (p12a !== "" || p12a !== "")) && (!p11b.includes("x") && !p12b.includes("x"))) {

                // Remove "x" and parse integers
                let n1 = parseInt(p11a.replace("x", ""));
                let n2 = parseInt(p12a.replace("x", ""));
                let d1 = parseInt(p11b.replace("x", ""));
                let d2 = parseInt(p12b.replace("x", ""));

                // Calculate num and den
                let num = o12o === "-" ? (n1 * d2 - n2 * d1) : (n1 * d2 + n2 * d1);
                element(`o1${x + 1}o`).children[0].innerHTML = "+"
                let den = d1 * d2;

                // Find gcd
                let g = gcd(num, den);

                // Simplify fraction
                num = num / g;
                den = den / g;

                // Update DOM
                element(`p1${x}`).children[0].innerHTML = element(`p1${x}`).children[0].innerHTML.includes("x") ? num + "x" : num;
                element(`p1${x}`).children[1].innerHTML = element(`p1${x}`).children[1].innerHTML.includes("x") ? den + "x" : den;
                element(`p1${x + 1}`).children[0].innerHTML = "0";
                element(`p1${x + 1}`).children[1].innerHTML = "0";

                newArray.push(
                    element(`p1${x}`).children[0].innerHTML.includes("x") ? num + "x" : num,
                    "+",
                    element(`p1${x}`).children[1].innerHTML.includes("x") ? den + "x" : den,
                 )
            }
        }


        for (let x of [0, 3, 5, 8]) {
            if (element(available[x]).innerHTML === "1x") element(available[x]).innerHTML = "x"
            if (element(available[x]).innerHTML === "-1x") element(available[x]).innerHTML = "-x"
            if (element(available[x]).innerHTML === "" || element(available[x]).innerHTML === "0") {
                element(available[x]).innerHTML = "0"
                element(available[x + 1]).remove()
                setAttributes(element(available[x]), { "class": "int", "id": "" })

            } else if (element(available[x]).innerHTML !== "") {
                if (element(available[x + 1]).innerHTML === "1" || element(available[x + 1]).innerHTML === "") {
                    setAttributes(element(available[x]), { "class": "int", "id": "" })
                    element(available[x + 1]).remove()

                } else {
                    setAttributes(element(available[x]), { "class": "num", "id": "" })
                    setAttributes(element(available[x + 1]), { "class": "int", "id": "" })
                }
            }
        }

        element("o12oa").innerHTML = `${element("o12oa").innerHTML === "-" ? "-" : "+"}`
        element("o14oa").innerHTML = `${element("o14oa").innerHTML === "-" ? "-" : "+"}`
        setAttributes(element("o12oa"), { "class": "int", "id": "" })
        setAttributes(element("o14oa"), { "class": "int", "id": "" })

        completeCheckWithAddEquation()

    } else {
        //stop it working for empty balance row
        
        let balance = document.querySelectorAll(`[id^="b${row}"]`)
        let balanceString = ""
        balance.forEach((e) => {
            balanceString += e.innerHTML
        })

        if (balanceString === "") {
            console.log("nothing")
            return
        }
        let p = []; // Array to hold the current row's numerator and denominator values
        let b = []; // Array to hold the balance operations and values
        let s = [
            element(`o${row}2o`).children[0].innerHTML,
            element(`o${row}4o`).children[0].innerHTML
        ];

        // Process the current row's elements to populate the p array
        for (let x = 1; x < 5; x++) {
            if (element(`p${row}${x}`).children.length === 1) {
                if (element(`p${row}${x}`).children[0].innerHTML === "x") {
                    p.push(["1x", "1"]);
                } else {
                    p.push([element(`p${row}${x}`).children[0].innerHTML, "1"]);
                }
            } else {
                if (element(`p${row}${x}`).children[0].innerHTML === "x") {
                    p.push([
                        "1x",
                        element(`p${row}${x}`).children[1].innerHTML === "x" ? "1x" : element(`p${row}${x}`).children[1].innerHTML
                    ]);
                } else {
                    p.push([
                        element(`p${row}${x}`).children[0].innerHTML,
                        element(`p${row}${x}`).children[1].innerHTML === "x" ? "1x" : element(`p${row}${x}`).children[1].innerHTML
                    ]);
                }
            }



            // Handle the b array
            let bSplit = element(`b${row}${x}`).innerHTML.slice(1).split("/");
            let sign = element(`b${row}${x}`).innerHTML.slice(0, 1);
            if (bSplit.length === 1) bSplit.push("1");
            if (bSplit[0] === "x") bSplit[0] = "1x";
            if (bSplit[1] === "x") bSplit[1] = "1x";
            if (bSplit[0] === "") bSplit[1] = "";
            b.push([sign + bSplit[0], bSplit[1]]);
        }

        let p1 = s[0] === "-" && p[1][0][0] !== "-" ? ["-" + p[1][0], p[1][1]] : p[1]
        let p3 = s[1] === "-" && p[3][0][0] !== "-" ? ["-" + p[3][0], p[3][1]] : p[3]
        let newP = [
            p[0],
            p1,
            p[2],
            p3
        ]

        let initialRow = element(`row-${row}`)

        function checkRows(initial, final) {
            if (initial.children.length !== final.children.length) return;
            let dissimilar = 0
            for (let index = 0; index < initial.children.length; index++) {
                if (initial.children[index].children[0].innerHTML !== final.children[index].children[0].innerHTML) {
                    dissimilar++
                }
            }
            if (dissimilar === 0) back()
        }

        // Check for possible operations
        let extendCheck = checkExtend(newP, b);
        let xCheck = checkXWithAddition(newP, b);
        let multiplicationCheck = checkMultiplication(newP, b);
        let balanceCheck = checkBalance(b)

        // Perform the extend operation if valid
        if (!extendCheck.faults) {
            createNewRow(newP);
            for (let e of extendCheck.extentions) {
                extend(e[0], e[1], e[2], e[3]);
            }
            completeCheck()
            //let finalRow = element(`row-${row}`)
            //checkRows(initialRow, finalRow)
            return;
        }

        // Perform the multiplication operation if valid
        if (!multiplicationCheck.faults) {
            createNewRow(newP);
            multiplication(newP, b, multiplicationCheck.multiplications[0]);
            completeCheck()
            //let finalRow = element(`row-${row}`)
            //checkRows(initialRow, finalRow)
            return;
        }

        // Check the balance and perform the addition operation if valid

        if (!xCheck.faults && !balanceCheck.faults) {
            createNewRow(newP);
            addition(newP, b, xCheck.fractions);
            completeCheck()
            let finalRow = element(`row-${row}`)
            checkRows(initialRow, finalRow)
            return;
        }


        if (extendCheck.faults) {
            if (extendCheck.warning === "addition") {
                if (balanceCheck.faults) {
                    element("info-screen").innerHTML = warningsText("balance-fault", [balanceCheck.warning[0], balanceCheck.warning[1]])
                    return
                } else if (xCheck.faults) {
                    let warning = ""
                    if (xCheck["x-fault"].join("") !== "") {
                        warning = warningsText("x-fault", xCheck["x-fault"])
                    } else if (xCheck["invalidSign"].join("") !== "") {
                        warning = warningsText("x-fault", xCheck["invalidSign"])
                    } else if (xCheck["noCommonDenominator"].join("") !== "") {
                        warning = warningsText("x-fault", xCheck["noCommonDenominator"])
                    }
                    element("info-screen").innerHTML = warning
                    return;
                }
            } else if (extendCheck.warning === "multiplication") {
                if (multiplicationCheck.faults) {
                    console.log("multiplicationCheck.faults")
                    element("info-screen").innerHTML = multiplicationCheck.warning
                    return
                }
            } else {
                element("info-screen").innerHTML = extendCheck.warning
                return
            }
        }
    }
}


/**
 * Checks if the two expressions on the left-hand side of an equation are equal to the two expressions on the right-hand side.
 * The function ignores the order of terms within each side.
 *
 * @param {string[]} b - An array of four algebraic expressions representing an equation.
 * @returns {boolean} - True if the equation is balanced, false otherwise.
 */
function checkBalance(b) {
    if ([b[0], b[1]].sort().join() !== [b[2], b[3]].sort().join() || b.join("") === "") {
        let lhs = []
        let rhs = []
        lhs[0] = b[0][0] === "" || b[0][0] === "" ? "" : b[0][1] !== "1" ? `${b[0][0]}/${b[0][1]}` : b[0][0],
            lhs[1] = b[1][0] === "" || b[1][0] === "" ? "" : b[1][1] !== "1" ? `${b[1][0]}/${b[1][1]}` : b[1][0]
        rhs[0] = b[2][0] === "" || b[2][0] === "" ? "" : b[2][1] !== "1" ? `${b[2][0]}/${b[2][1]}` : b[2][0]
        rhs[1] = b[3][0] === "" || b[3][0] === "" ? "" : b[3][1] !== "1" ? `${b[3][0]}/${b[3][1]}` : b[3][0]

        return { "faults": true, "warning": [lhs.join(""), rhs.join("")] }
    }
    return { "faults": false, }
}


/**
 * Checks and validates positions for performing addition/subtraction with fractions that may include 'x'.
 * 
 * @param {Array} p - The array containing the positions (numerator and denominator).
 * @param {Array} b - The array containing the balance operations and values.
 * @returns {Array|null} - An array of positions for valid addition/subtraction or null if faults are found.
 */
function checkXWithAddition(p, b) {
    //console.log("checkXWithAddition");

    let faults = 0;               // Counter for faults
    let positionsToAdd = [];      // Positions to be considered for addition
    let fractionsToAdd = [];      // Positions for valid addition/subtraction
    let faultCode = { "faults": true, "x-fault": [], "invalidSign": [], "noCommonDenominator": [] }

    // Iterate through the positions
    for (let x = 0; x < 4; x++) {

        if (b[x][0] === "") continue; // Skip empty balance entries

        // Check if the balance has a valid sign and validate 'x' presence
        if (b[x][0][0] === "+" || b[x][0][0] === "-") {
            let faultPosition
            if (x === 0 || x === 1) {
                let target = element(`p${row}1`).children[0].innerHTML
                if (target === "0" || target === "") {
                    faultPosition = 1
                } else {
                    faultPosition = x + 1
                }
            }
            if (x === 2 || x === 3) {
                let target = element(`p${row}2`).children[0].innerHTML
                if (target === "0" || target === "") {
                    faultPosition = 2
                } else {
                    faultPosition = x + 1
                }
            }
            if (b[x][0].includes("x") && !(p[x][0].includes("x") || p[x][0] === "0")) {
                //console.log("Fail: b contains 'x' but p does not");
                faultCode["x-fault"].push(faultPosition)
                faults++;
            } else if (!b[x][0].includes("x") && p[x][0].includes("x")) {
                //console.log("Fail: p contains 'x' but b does not");
                faultCode["x-fault"].push(faultPosition)
                faults++;
            } else if (b[x][1].includes("x") && !(p[x][1].includes("x") || p[x][0] === "0")) {
                //console.log("Fail: b denominator contains 'x' but p does not");
                faultCode["x-fault"].push(faultPosition)
                faults++;
            } else if (!b[x][1].includes("x") && p[x][1].includes("x")) {
                //console.log("Fail: p denominator contains 'x' but b does not");
                faultCode["x-fault"].push(faultPosition)
                faults++;
            } else {
                positionsToAdd.push(x); // Add position to the list if valid
            }
            //console.log(faultCode)
            //console.log(`faults: ${faults}, positionsToAdd: ${positionsToAdd}`);
        } else {
            //console.log("Fail: invalid sign in b", x);
            faultCode["invalidSign"].push(x) //TODO position can be wrong +1
            faults++;
        }
    }

    // Validate denominators and prepare final positions for addition/subtraction
    for (let x of positionsToAdd) {
        if (p[x][1] !== b[x][1] && b[x][0] !== "") {
            //console.log("Fail: mismatched denominators");
            faultCode["noCommonDenominator"].push(x) //TODO position can be wrong +1
            faults++;
        } else {
            fractionsToAdd.push(x); // Add position to the list if denominators match
        }
        //console.log(`faults: ${faults}, fractionsToAdd: ${fractionsToAdd}`);
    }

    // Return null if faults are found, else return positions for addition/subtraction
    if (faults > 0) {
        return faultCode
    } else {
        //console.log("No problems with x and addition/subtraction");
        return { "faults": false, "fractions": [fractionsToAdd] };
    }
}


/**
 * Checks the validity of multiplication or division operations in the given arrays.
 * @param {Array} p - The array containing current positions.
 * @param {Array} b - The array containing operation indicators.
 * @returns {Array|null} - Returns an array with filled positions, empty positions, and positions with x, or null if invalid.
 */
function checkMultiplication(p, b) {
    //console.log("checkMultiplication");

    let emptyPosition = [];
    let filledPosition = [];

    // Identify empty and filled positions
    for (let x = 0; x < 4; x++) {
        if (p[x][0] === "" || p[x][0] === "0") {
            emptyPosition.push(x);
        } else {
            filledPosition.push(x);
        }
    }

    let bCheck = ""
    for (let x = 0; x < 4; x++) {
        bCheck += b[x][0]
    }


    // Ensure all filled positions have the same operation
    //console.log(b)
    let lastPositionNum = b[filledPosition[0]][0];
    let lastPositionDen = b[filledPosition[0]][1];
    let extentionOrMultiplication = 0
    for (let x of filledPosition) {
        if ((b[x][0] !== lastPositionNum || b[x][0] === "" || b[x][0] === "0") || (b[x][1] !== lastPositionDen)) {
            //return {"faults": true, "warning": "all positions must have same value"};
            extentionOrMultiplication++;
        }
        lastPositionNum = b[x][0];
        lastPositionDen = b[x][1];
    }
    //console.log("exOrM", extentionOrMultiplication, "FP", filledPosition.length)
    if (extentionOrMultiplication > 0) {
        return { "faults": true, "warning": "all positions must have same value" };
    }



    // Check for valid x-squared positions
    let mx = checkForXSquared(p, b);
    if (!mx) {

        return { "faults": true, "warning": "cant process x-squared" };
    }

    //console.log("No problems with multiplication/division");
    return { "faults": false, "multiplications": [filledPosition, emptyPosition, mx] };
}


/**
 * Checks if the fractions in the balance array `b` can be extended or reduced.
 * @param {Array} p - The array containing the positions.
 * @param {Array} b - The array containing the balance operations and values.
 * @returns {Array|null} - An array of details for extending/reducing the fractions or null if no such operations are found.
 */
function checkExtend(p, b) {
    //console.log("check extend");

    let a = [];        // Stores indices of valid operations
    let possibles = []
    let additions = []
    let reduce = [];   // Stores whether to reduce (true) or extend (false)
    let ext = [];      // Stores the result array to be returned

    // Iterate through balance array `b` to find valid operations
    for (let x = 0; x < b.length; x++) {
        // Check for multiplication/division where both parts are the same non-empty value
        if ("/*".includes(b[x][0][0]) && (b[x][0].slice(1) === b[x][1]) && (b[x][0].slice(1) !== "")) {
            a.push(x);
            reduce.push(b[x][0][0] === "*" ? false : true); // Determine if it's a reduction or extension
        } else if ("/*".includes(b[x][0][0]) && (b[x][0].slice(1) !== b[x][1]) && (b[x][0].slice(1) !== "")) {
            possibles.push(x)
        } else if ("-+".includes(b[x][0][0])) {
            additions.push(x)
        }
    }

    // If no valid operations are found, return null
    if (a.length === 0) {
        if (possibles.length === 1 && additions.length === 0) {
            if (b[possibles[0]][0][0] === "*") {
                return { "faults": true, "warning": "extensionFault" };
            } else {
                return { "faults": true, "warning": "reductionFault" };
            }

        } else if (possibles.length === 0) {
            return { "faults": true, "warning": "addition" };
        } else if (possibles.length >= 0 && additions.length === 0) {
            let checkNum = b[possibles[0]][0]
            let checkDen = b[possibles[0]][1]
            for (let x = 0; x < possibles.length - 1; x++) {
                if (checkNum === b[x][0] && checkDen === b[x][1]) {
                    checkNum = b[possibles[x]][0]
                    checkDen = b[possibles[x]][1]
                } else {
                    return { "faults": true, "warning": "extention-multiplication" };
                }
            }
            return { "faults": true, "warning": "multiplication" };
        };
    } else if (a.length > 0) {
        if (additions.length >= 1) {
            return { "faults": true, "warning": "mixed-operations" };
        } else if (possibles.length > 0) {
            if (a.length >= possibles.length) {
                return { "faults": true, "warning": "mixed-multiplications" };
            } else {
                return { "faults": true, "warning": "multiplication" };
            }

        }
    }

    // Prepare the `ext` array with the necessary details
    for (let x = 0; x < a.length; x++) {
        ext.push([p, b[a[x]][0].slice(1), a[x], reduce[x]]);
    }

    // Return the array of details for extending/reducing the fractions
    return { "faults": false, "extentions": ext };
}


/**
 * Creates a new row in the document with the given positions and signs.
 * @param {Array} p - The array containing the positions to be added to the new row.
 */
function createNewRow(p) {

    let newRowGroup = document.createElement("div")
    let newRow = document.createElement("div");
    let newRowInfo = document.createElement("div")
    setAttributes(newRowGroup, { "id": `row-group-${row + 1}`, "class": "row-group" });
    setAttributes(newRow, { "id": `row-${row + 1}`, "class": "row", });
    setAttributes(newRowInfo, { "id": `row-info-${row + 1}`, "class": "row-info" });

    newRowInfo.innerHTML = `<svg width="400px" height="60px" xmlns="http://www.w3.org/2000/svg">
    <path d=${infoShape} stroke="black" fill="white"/>
    <text X="37" Y="25" >the equation that should be solved</text>
    <text X="37" Y="45" >for "x" using the balance method</text>
</svg>`

    let oldText = [];
    let signOne = `<div class="int">+</div>`;
    let signTwo = `<div class="int">+</div>`;

    for (let x = 0; x < 4; x++) {
        if (p[x][0] === "0") {
            oldText.push(`<div class="int">${p[x][0]}</div>`);
        } else if (p[x][1] === "1") {
            oldText.push(`<div class="int">${p[x][0]}</div>`);
        } else {
            oldText.push(`<div class="num">${p[x][0]}</div><div class="int">${p[x][1]}</div>`);
        }
    }

    newRow.innerHTML = `
        <div id="p${row + 1}1" class="plhs">${oldText[0]}</div>
        <div id="o${row + 1}2o" class="plhs">${signOne}</div>
        <div id="p${row + 1}2" class="plhs">${oldText[1]}</div>
        <div class="plhs">
            <div id="e" class="int">=</div>
        </div>
        <div id="p${row + 1}3" class="prhs">${oldText[2]}</div>
        <div id="o${row + 1}4o" class="prhs">${signTwo}</div>
        <div id="p${row + 1}4" class="prhs">${oldText[3]}</div>
    `;

    newRowGroup.appendChild(newRow)
    newRowGroup.appendChild(newRowInfo)
    element("left").appendChild(newRowGroup);
    element(`row-info-${row}`).style.display = "none"
}


/**
 * Updates the signs in the current row based on the values.
 */
function updateRow() {
    let newRow = element(`row-${row}`);

    // Update the signs and values based on conditions
    if (newRow.children[0].children[0].innerHTML === "0" && newRow.children[1].children[0].innerHTML === "-") {
        newRow.children[2].children[0].innerHTML = "-" + newRow.children[2].children[0].innerHTML;
        newRow.children[1].children[0].innerHTML = "+";
    }
    if (newRow.children[4].children[0].innerHTML === "0" && newRow.children[5].children[0].innerHTML === "-") {
        newRow.children[6].children[0].innerHTML = "-" + newRow.children[6].children[0].innerHTML;
        newRow.children[5].children[0].innerHTML = "+";
    }
    if (newRow.children[0].children[0].innerHTML !== "0" && newRow.children[2].children[0].innerHTML[0] === "-") {
        newRow.children[2].children[0].innerHTML = newRow.children[2].children[0].innerHTML.slice(1);
        newRow.children[1].children[0].innerHTML = "-";
    }
    if (newRow.children[4].children[0].innerHTML !== "0" && newRow.children[6].children[0].innerHTML[0] === "-") {
        newRow.children[6].children[0].innerHTML = newRow.children[6].children[0].innerHTML.slice(1);
        newRow.children[5].children[0].innerHTML = "-";
    }
    for (let x = 0; x < 7; x += 2) {
        if (newRow.children[x].children[0].innerHTML === "1x") newRow.children[x].children[0].innerHTML = "x"
        if (newRow.children[x].children[0].innerHTML === "-1x") newRow.children[x].children[0].innerHTML = "-x"

        if (newRow.children[x].length > 1) {
            if (newRow.children[x].children[1].innerHTML === "1x") newRow.children[x].children[1].innerHTML = "x"
            if (newRow.children[x].children[1].innerHTML === "-1x") newRow.children[x].children[1].innerHTML = "-x"

        }
    }
}


/**
 * Creates a balance row in the document.
 */
function createBalanceRow() {

    let newRowGroup = document.createElement("div")
    let newRow = document.createElement("div");
    let newRowInfo = document.createElement("div")
    setAttributes(newRowGroup, { "id": `bal-group-${row}`, "class": "bal-group", });
    setAttributes(newRow, { "id": `bal-${row}`, "class": "bal" });
    setAttributes(newRowInfo, { "id": `bal-info-${row}`, "class": "bal-info", });

    newRowInfo.innerHTML = `<svg width="400px" height="60px" xmlns="http://www.w3.org/2000/svg">
    <path d=${infoShape} stroke="black" fill="white"/>
    <text X="37" Y="25" >enter an operation in the box under</text>
    <text X="37" Y="45" >the term that you want to manipulate</text>
</svg>`

    newRow.innerHTML = `
        <div id="b${row}1" class="blhs" onmousedown="select(id)"></div>
        <div id="b${row}2b" class="blank"></div>
        <div id="b${row}2" class="blhs" onmousedown="select(id)"></div>
        <div id="b${row}3b" class="blank"></div>
        <div id="b${row}3" class="brhs" onmousedown="select(id)"></div>
        <div id="b${row}4b" class="blank"></div>
        <div id="b${row}4" class="brhs" onmousedown="select(id)"></div>
    `;

    newRowGroup.appendChild(newRow)
    newRowGroup.appendChild(newRowInfo)
    element("left").appendChild(newRowGroup);
    if (row > 1) element(`bal-info-${row - 1}`).style.display = "none"
}


/**
* Extends or reduces a fraction at a given position and updates the corresponding element.
* @param {Array} positions - Array containing the positions to be extended.
* @param {number|string} fraction - The fraction to extend or reduce by.
* @param {number} position - The position to process.
* @param {boolean} reduce - Whether to reduce the fraction.
*/
function extend(positions, fraction, position, reduce) {
    const { num, den, hasXnum, hasXden } = parsePositions(positions, position);
    const { newNum, newDen } = calculateNewValues(num, den, fraction, reduce);
    if (newNum === null || newDen === null) return;
    updateElementWithExtend(newNum, newDen, hasXnum, hasXden, position);
}


/**
 * Parses the positions array to extract numerator and denominator values.
 * @param {Array} positions - Array containing the positions to be extended.
 * @param {number} position - The position to process.
 * @returns {Object} - Object containing num, den, hasXnum, hasXden.
 */
function parsePositions(positions, position) {
    let num, den;
    let hasXnum = false;
    let hasXden = false;

    if (positions[position].length === 1) {
        if (positions[position][0].includes("x")) {
            hasXnum = true;
            num = parseInt(positions[position][0].replace("x", ""));
            den = 1;
        } else {
            hasXnum = false;
            num = parseInt(positions[position][0]);
            den = 1;
        }
    } else {
        if (positions[position][0].includes("x")) {
            hasXnum = true;
            num = parseInt(positions[position][0].replace("x", ""));
        } else {
            hasXnum = false;
            num = parseInt(positions[position][0]);
        }
        if (positions[position][1].includes("x")) {
            hasXden = true;
            den = parseInt(positions[position][1].replace("x", ""));
        } else {
            hasXden = false;
            den = parseInt(positions[position][1]);
        }
    }
    return { num, den, hasXnum, hasXden };
}


/**
 * Calculates the new numerator and denominator based on the fraction and reduce flag.
 * @param {number} num - The numerator.
 * @param {number} den - The denominator.
 * @param {number|string} fraction - The fraction to extend or reduce by.
 * @param {boolean} reduce - Whether to reduce the fraction.
 * @returns {Object} - Object containing newNum and newDen.
 */
function calculateNewValues(num, den, fraction, reduce) {
    let newNum, newDen;

    if (!reduce) {
        newNum = parseInt(fraction) * num;
        newDen = parseInt(fraction) * den;
    } else {
        console.log("reduce")
        if (num % parseInt(fraction) === 0 && den % parseInt(fraction) === 0) {
            newNum = num / parseInt(fraction);
            newDen = den / parseInt(fraction);
        } else {
            return { newNum: null, newDen: null };
        }
    }

    return { newNum, newDen };
}


/**
 * Updates the HTML element with the new numerator and denominator values.
 * @param {number} newNum - The new numerator.
 * @param {number} newDen - The new denominator.
 * @param {boolean} hasXnum - Whether the numerator contains an 'x'.
 * @param {boolean} hasXden - Whether the denominator contains an 'x'.
 * @param {number} position - The position to update.
 */
function updateElementWithExtend(newNum, newDen, hasXnum, hasXden, position) {
    let newRow = element(`row-${row + 1}`);
    newRow.children[position * 2].innerHTML = "";

    let numElement = document.createElement("div");
    let denElement = document.createElement("div");
    setAttributes(numElement, { "class": "num" });
    setAttributes(denElement, { "class": "int" });

    const numText = hasXnum ? newNum.toString() + "x" : newNum.toString();
    const denText = hasXden ? newDen.toString() + "x" : newDen.toString();

    if (denText === "1") {
        denElement.innerHTML = numText;
        newRow.children[position * 2].appendChild(denElement);
    } else {
        numElement.innerHTML = numText;
        denElement.innerHTML = denText;
        newRow.children[position * 2].appendChild(numElement);
        newRow.children[position * 2].appendChild(denElement);
    }
}


/**
 * Performs addition or subtraction on the given arrays and updates the elements accordingly.
 * @param {Array} p - Array of terms.
 * @param {Array} b - Array of balance terms.
 * @param {Array} s - Array of signs.
 * @param {Array} a - Array of indices to process.
 */
function addition(p, b, a) {
    a[0].forEach(index => processIndex(index, p, b));
    let target = element(`row-${row + 1}`)
    let infoText = ""
    for (let x = 0; x < 7; x += 2) {
        if (target.children[x].children.length > 1) {
            let numHasX = target.children[x].children[0].innerHTML.includes("x") ? true : false
            let denHasX = target.children[x].children[1].innerHTML.includes("x") ? true : false
            let num = parseInt(target.children[x].children[0].innerHTML.replace("x", ""))
            let den = parseInt(target.children[x].children[1].innerHTML.replace("x", ""))
            let g = gcd(num, den)
            let oldText = `${target.children[x].children[0].innerHTML}/${target.children[x].children[1].innerHTML}`
            let newText = ""
            num = num / g
            den = den / g
            if (den === 1) {
                target.children[x].innerHTML = `<div class="int">${numHasX ? num + "x" : num}</div></div>`
                newText = numHasX ? `${num}x` : num
                infoText = g !== 1 ? infoText + `${oldText} = ${newText} <br><br>` : infoText
            } else {
                target.children[x].children[0].innerHTML = numHasX ? num + "x" : num
                target.children[x].children[1].innerHTML = denHasX ? den + "x" : den
                newText = numHasX ? `${num}x/${den}` : denHasX ? `${num}/${den}x` : `${num}/${den}`
                infoText = g !== 1 ? infoText + `${oldText} = ${newText} <br><br>` : infoText
            }
        }
    }
    element("info-screen").innerHTML = infoText
}


/**
 * Processes each index to perform the addition or subtraction.
 * @param {number} index - The index to process.
 * @param {Array} p - Array of terms.
 * @param {Array} b - Array of balance terms.
 * @param {Array} s - Array of signs.
 */
function processIndex(index, p, b) {
    let pValue = getPValue(index, p);
    let bValue = parseInt(b[index][0].slice(1).replace("x", ""));
    let result = calculateResult(pValue, bValue, b[index][0][0]);
    updateElementWithAddition(result, index, p, b);
}


/**
 * Gets the value of p after considering the sign.
 * @param {number} index - The index to process.
 * @param {Array} p - Array of terms.
 * @param {Array} s - Array of signs.
 * @returns {number} - The processed p value.
 */
function getPValue(index, p) {
    return parseInt(p[index][0].replace("x", ""));

}


/**
 * Calculates the result of addition or subtraction.
 * @param {number} pValue - The value from p array.
 * @param {number} bValue - The value from b array.
 * @param {string} operation - The operation ('+' or '-') to perform.
 * @returns {number} - The result of the operation.
 */
function calculateResult(pValue, bValue, operation) {
    if (operation === "+") {
        return pValue + bValue;
    } else {
        return pValue - bValue;
    }
}


/**
 * Updates the element with the result.
 * @param {number} result - The result of the operation.
 * @param {number} index - The index to update.
 * @param {Array} p - Array of terms.
 */
function updateElementWithAddition(result, index, p, b) {
    let resultString = getResultString(result, p[index][0], b[index][0]);
    let elementId = `p${row + 1}${index + 1}`;
    if (result === 0) {
        element(elementId).innerHTML = '<div class="int">0</div>';
    } else {
        element(elementId).children[0].innerHTML = resultString;
    }
}


/**
 * Gets the result string based on the result and original value.
 * @param {number} result - The result of the operation.
 * @param {string} original - The original value.
 * @returns {string} - The result string.
 */
function getResultString(result, original, balance) {
    if (result === 0) {
        return "0";
    } else {
        return original.includes("x") || balance.includes("x") ? result + "x" : result.toString();
    }
}


/**
 * Sets the content of an element based on the provided parameters.
 * @param {Array} p - Array of terms.
 * @param {Array} b - Array of balance terms.
 * @param {string} s - Sign.
 * @param {number} x - Index.
 * @param {HTMLElement} newRow - The new row element.
 */
function setElementContent(p, b, x, newRow) {
    if (p[0] === "-x") p[0] = "-1x"
    if (p[1] === "-x") p[1] = "-1x"
    let numElement = document.createElement("div");
    let denElement = document.createElement("div");

    setAttributes(numElement, { "class": "num" });
    setAttributes(denElement, { "class": "int" });

    let num, den;
    if (b[0][0] === "*") {
        num = parseInt(p[0].replace("x", "")) * parseInt(b[0].slice(1).replace("x", ""));
        den = parseInt(p[1].replace("x", "")) * parseInt(b[1].replace("x", ""));
        if (den < 0) {
            num = num * (-1)
            den = den * (-1)
        }
    } else {
        num = parseInt(p[0].replace("x", "")) * parseInt(b[1].replace("x", ""));
        den = parseInt(p[1].replace("x", "")) * parseInt(b[0].slice(1).replace("x", ""));
        if (den < 0) {
            num = num * (-1)
            den = den * (-1)
        }
    }


    let g = gcd(num, den);
    num = num / g;
    den = den / g;


    let [numHasX, denHasX] = getVariablesStatus(b, p);


    if (den === 1 && !denHasX) {
        denElement.innerHTML = Math.abs(num) !== 1 ? (numHasX ? num + "x" : num) : (numHasX ? (num < 0 ? "-x" : "x") : num);
        newRow.children[x * 2].appendChild(denElement);
    } else {
        numElement.innerHTML = Math.abs(num) !== 1 ? (numHasX ? num + "x" : num) : (numHasX ? "x" : num);
        denElement.innerHTML = Math.abs(den) !== 1 ? (denHasX ? den + "x" : den) : (denHasX ? "x" : den);
        newRow.children[x * 2].appendChild(numElement);
        newRow.children[x * 2].appendChild(denElement);
    }
}


/**
 * Determines if the numerator or denominator has a variable 'x'.
 * @param {Array} b - Array of balance terms.
 * @param {Array} p - Array of terms.
 * @returns {Array} - Boolean values indicating if numerator and denominator have 'x'.
 */
function getVariablesStatus(b, p) {
    let numHasX = false, denHasX = false;

    if (b[0].includes("x")) {
        if (b[0][0] === "*") {
            numHasX = (!p[1].includes("x") || (p[0].includes("x") && p[1].includes("x")));
        } else if (b[0][0] === "/") {
            numHasX = (p[0].includes("x") && p[1].includes("x"));
            denHasX = (!p[0].includes("x") || (p[0].includes("x") && p[1].includes("x")));
        }
    } else if (b[1].includes("x")) {
        if (b[0][0] === "*") {
            denHasX = (!p[0].includes("x") || (p[0].includes("x") && p[1].includes("x")));
        } else if (b[0][0] === "/") {
            numHasX = (p[0].includes("x") && p[1].includes("x"));
        }
    } else {
        if (p[0].includes("x")) {
            numHasX = true;
        } else if (p[1].includes("x")) {
            denHasX = true;
        }
    }

    return [numHasX, denHasX];
}


/**
 * Performs multiplication and sets the content for each element.
 * @param {Array} p - Array of terms.
 * @param {Array} b - Array of balance terms.
 * @param {Array} s - Array of signs.
 * @param {Array} a - Array of indices.
 */
function multiplication(p, b, a) {
    let newRow = document.getElementById(`row-${row + 1}`);
    for (let x of a) {
        newRow.children[x * 2].innerHTML = "";
        setElementContent(p[x], b[x], x, newRow);
    }
}


/**
 * Checks for the presence of 'x^2' in terms.
 * @param {Array} p - Array of terms.
 * @param {Array} b - Array of balance terms.
 * @returns {Array|null} - Array of positions or null if invalid.
 */
function checkForXSquared(p, b) {
    let positions = [];
    for (let x = 0; x < 4; x++) {
        if (b[x][0].includes("x") && (p[x][0].includes("x") || p[x][1].includes("x"))) {
            if (b[x][0][0] === "*" && !p[x][0].includes("x")) {
                positions.push(x);
            } else if (b[x][0][0] === "/" && !p[x][1].includes("x")) {
                positions.push(x);
            } else {
                positions.push("e");
            }
        }
    }
    if (positions.join("").includes("e")) return null;
    return positions;
}


/**
 * Hides unused elements based on certain conditions.
 */
function hideUnused() {
    let prhs = getElementsContent(`[id^='p${row}']:not(.plhs)`);
    let plhs = getElementsContent(`[id^='p${row}']:not(.prhs)`);
    handleLeftSide(plhs);
    handleRightSide(prhs);
}


/**
     * Hides elements based on the given indices and offset.
     * @param {number} offset - Offset for the index.
     * @param {number} index - Index of the element.
     */
function hideElements(offset, index) {
    hideElement(`p${row}${index}`);
    hideElement(`b${row}${index}`);
    hideElement(`o${row}${index + offset}o`);
    hideElement(`b${row}${index + offset}b`);
}


/**
 * Gets the content of elements based on the provided selector.
 * @param {string} selector - The selector to match elements.
 * @returns {Array} - Array of element content.
 */
function getElementsContent(selector) {
    let content = [];
    document.querySelectorAll(selector).forEach((e) => content.push(e.children[0].innerHTML));
    return content;
}


/**
 * Hides an element by setting its display style to none.
 * @param {string} id - The ID of the element to hide.
 */
function hideElement(id) {
    element(id).setAttribute("style", "display:none;");
}


/**
 * Handles hiding elements on the left side based on their content.
 * @param {Array} plhs - Array of left-hand side element content.
 */
function handleLeftSide(plhs) {
    if (plhs[0] === "0" && plhs[1] !== "0") {
        hideElements(1, 1);
        adjustMargins();
        updateAvailableAndSelect(`b${row}1`);
    } else if (plhs[0] !== "0" && plhs[1] === "0") {
        hideElements(0, 2);
        adjustMargins();
        updateAvailableAndSelect(`b${row}2`);
    } else if (plhs[0] === "0" && plhs[1] === "0") {
        hideElements(0, 2);
        adjustMargins();
        updateAvailableAndSelect(`b${row}2`);
    }
}


/**
 * Handles hiding elements on the right side based on their content.
 * @param {Array} prhs - Array of right-hand side element content.
 */
function handleRightSide(prhs) {
    if (prhs[0] === "0" && prhs[1] !== "0") {
        hideElements(1, 3);
        updateAvailableAndSelect(`b${row}3`);
    } else if (prhs[0] !== "0" && prhs[1] === "0") {
        hideElements(0, 4);
        updateAvailableAndSelect(`b${row}4`);
    } else if (prhs[0] === "0" && prhs[1] === "0") {
        hideElements(0, 4);
        updateAvailableAndSelect(`b${row}4`);
    }
}


/**
 * Adjusts the margins for the row and balance elements.
 */
function adjustMargins() {
    element(`row-${row}`).setAttribute("style", "margin-left:80px;");
    element(`bal-${row}`).setAttribute("style", "margin-left:79px;");
}


/**
 * Updates the available elements and selects the next available one.
 * @param {string} id - The ID of the element to remove from the available list.
 */
function updateAvailableAndSelect(id) {
    available = removeByValue(id, available);
    select(available[0]);
}


/**
 * Removes a value from an array.
 * @param {string} value - The value to remove.
 * @param {Array} array - The array to remove the value from.
 * @returns {Array} - The updated array.
 */
function removeByValue(value, array) {
    return array.filter(item => item !== value);
}



function createHistory(newArray) {
    historyId ++
    let hcid = `hc${historyId}`
    let hrid = `hr${historyId}`
    let hbid = `hb${historyId}`
    let historyArray = [...newArray]
    history[hcid] = historyArray
    let historyText = `
        <div id="${hrid}-1" class="plhs"><div class="num">${newArray[0]}</div><div class="int">${newArray[1]}</div></div>
        <div id="${hrid}-2o" class="plhs"><div class="int">${newArray[2]}</div></div>
        <div id="${hrid}-2" class="plhs"><div class="num">${newArray[3]}</div><div class="int">${newArray[4]}</div></div>
        <div class="plhs">
            <div id="he" class="int">=</div>
        </div>
        <div id="${hrid}-3" class="prhs"><div class="num">${newArray[5]}</div><div class="int">${newArray[6]}</div></div>
        <div id="${hrid}-4o" class="prhs"><div class="int">${newArray[7]}</div></div>
        <div id="${hrid}-4" class="prhs"><div class="num">${newArray[8]}</div><div class="int">${newArray[9]}</div></div>
    `;
    let historyContainer = document.createElement("div")
    let historyRow = document.createElement("div")
    let deleteButton = document.createElement("div")
    let buttonContainer = document.createElement("div")
    setAttributes(historyContainer, {
        "class": "history-container",
        "id": hcid
    })
    setAttributes(historyRow, {
        "class": "history-row",
        "id": hrid,
        "onclick": `enterHistory("${hcid}")`
    })
    setAttributes(deleteButton, {
        "class": "history-button",
        "id": hbid,
        "onclick": `hideElement("${hcid}")`
    })
    setAttributes(buttonContainer, {
        "class": "button-container",
    })

    historyRow.innerHTML = historyText
    buttonContainer.appendChild(deleteButton)
    historyContainer.appendChild(buttonContainer)
    historyContainer.appendChild(historyRow)
    element("history-shell").appendChild(historyContainer)
    element("history-outside").scrollTop = element("history-outside").scrollHeight
    hideUnused()
    updateRow()
    

    function getElementsContent(selector) {
        let content = [];
        document.querySelectorAll(selector).forEach((e) => content.push(e.children[0].innerHTML));
        return content;
    }

    function hideUnused() {
        let prhs = getElementsContent(`[id^='${hrid}']:not(.plhs):not(.history-row)`);
        let plhs = getElementsContent(`[id^='${hrid}']:not(.prhs):not(.history-row)`);
        handleLeftSide(plhs);
        handleRightSide(prhs);
        
    }
    
    function handleRightSide(prhs) {
        if ((prhs[0] === "0"||prhs[0] === "") && prhs[2] !== "0") {
            hideElements(1, 3);
        } else if (prhs[0] !== "0" && (prhs[2] === "0"||prhs[2] === "")) {
            hideElements(0, 4);
        } else if ((prhs[0] === "0"||prhs[0] === "") && (prhs[2] === "0"||prhs[2] === "")) {
            hideElements(0, 4);
        }
    }

    function handleLeftSide(plhs) {
        if ((plhs[0] === "0"||plhs[0] === "") && plhs[2] !== "0") {
            hideElements(1, 1);
            adjustMargins();
        } else if (plhs[0] !== "0" && (plhs[2] === "0"||plhs[2] === "")) {
            hideElements(0, 2);
            adjustMargins();
        } else if ((plhs[0] === "0"||plhs[0] === "")  && (plhs[2] === "0"||plhs[2] === "")) {
            hideElements(0, 2);
            adjustMargins();
        }
    }
    
    function hideElements(offset, index) {
        hideElement(`${hrid}-${index}`);
        hideElement(`${hrid}-${index + offset}o`);
    }

    function adjustMargins() {
        element(`${hrid}`).setAttribute("style", "margin-left:80px;");
        element(`${hrid}`).setAttribute("style", "margin-left:80px;");
    }

    function updateRow() {
        let newRow = element(`${hrid}`);
    
        // Update the signs and values based on conditions
        if (newRow.children[0].children[0].innerHTML === "0" && newRow.children[1].children[0].innerHTML === "-") {
            newRow.children[2].children[0].innerHTML = "-" + newRow.children[2].children[0].innerHTML;
            newRow.children[1].children[0].innerHTML = "+";
        }
        if (newRow.children[4].children[0].innerHTML === "0" && newRow.children[5].children[0].innerHTML === "-") {
            newRow.children[6].children[0].innerHTML = "-" + newRow.children[6].children[0].innerHTML;
            newRow.children[5].children[0].innerHTML = "+";
        }
        if (newRow.children[0].children[0].innerHTML !== "0" && newRow.children[2].children[0].innerHTML[0] === "-") {
            newRow.children[2].children[0].innerHTML = newRow.children[2].children[0].innerHTML.slice(1);
            newRow.children[1].children[0].innerHTML = "-";
        }
        if (newRow.children[4].children[0].innerHTML !== "0" && newRow.children[6].children[0].innerHTML[0] === "-") {
            newRow.children[6].children[0].innerHTML = newRow.children[6].children[0].innerHTML.slice(1);
            newRow.children[5].children[0].innerHTML = "-";
        }
        for (let x = 0; x < 7; x += 2) {
            if (newRow.children[x].children[0].innerHTML === "1x") newRow.children[x].children[0].innerHTML = "x"
            if (newRow.children[x].children[0].innerHTML === "-1x") newRow.children[x].children[0].innerHTML = "-x"
    
            if (newRow.children[x].length > 1) {
                if (newRow.children[x].children[1].innerHTML === "1x") newRow.children[x].children[1].innerHTML = "x"
                if (newRow.children[x].children[1].innerHTML === "-1x") newRow.children[x].children[1].innerHTML = "-x"
    
            }
            if (newRow.children[x].children[1].innerHTML === "1") newRow.children[x].innerHTML = `<div class="int">${newRow.children[x].children[0].innerHTML}</div>`
        }
    }

}

function enterHistory(id) {
    hideElement(id)
    addEquation(3, history[id])
}

function clearHistory() {
    element("history-shell").innerHTML = ""
    
}

function infoPopup() {
    element("info-popup").style.display = popupOpen ? "none" : "flex";
    popupOpen = !popupOpen
}

</script>
</body>
</html>
